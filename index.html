<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRM Farmacias - Sistema Unificado v2.8</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* ================================
           MODERN CRM STYLES - v2.8
           ================================ */

        :root {
            /* === COLORES === */
            --primary-50: #eff6ff;
            --primary-100: #dbeafe;
            --primary-500: #3b82f6;
            --primary-600: #2563eb;
            --primary-700: #1d4ed8;
            
            --success-500: #10b981;
            --success-600: #059669;
            --danger-500: #ef4444;
            --danger-600: #dc2626;
            --warning-500: #f59e0b;
            --info-500: #06b6d4;
            
            /* Color para Justificada */
            --indigo-100: #e0e7ff;
            --indigo-500: #6366f1;
            --indigo-600: #4f46e5;
            --indigo-700: #4338ca;

            /* === TEMA CLARO === */
            --bg-primary: #ffffff;
            --bg-secondary: #f8fafc;
            --bg-tertiary: #f1f5f9;
            --text-primary: #0f172a;
            --text-secondary: #475569;
            --text-tertiary: #64748b;
            --border-color: #e2e8f0;
            
            /* === UI VARIABLES === */
            --radius-lg: 0.5rem;
            --radius-xl: 0.75rem;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            --font-primary: 'Inter', system-ui, sans-serif;
            
            color-scheme: light;
        }

        [data-theme="dark"] {
            --bg-primary: #1f2937;
            --bg-secondary: #111827;
            --bg-tertiary: #374151;
            --text-primary: #f9fafb;
            --text-secondary: #d1d5db;
            --text-tertiary: #9ca3af;
            --border-color: #374151;
            
            /* Ajuste de Indigo para Dark Mode */
            --indigo-100: #312e81; /* Fondo oscuro */
            --indigo-500: #818cf8; /* Texto claro */
            --indigo-600: #6366f1; /* Borde */
            
            color-scheme: dark;
        }

        /* === BASE === */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: var(--font-primary);
            background: var(--bg-secondary);
            color: var(--text-primary);
            line-height: 1.5;
            transition: background-color 0.3s, color 0.3s;
        }

        /* === COMPONENTS === */
        .container {
            width: 100%;
            max-width: 1400px;
            margin: 0 auto;
            padding: 1.5rem;
        }

        /* Login */
        .login-container-modern {
            max-width: 420px;
            margin-top: 5vh;
        }
        .login-card {
            background: var(--bg-primary);
            padding: 2rem;
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-color);
        }
        .brand-icon { font-size: 3rem; text-align: center; margin-bottom: 1rem; }
        .login-header h1 { text-align: center; font-size: 1.5rem; margin-bottom: 0.5rem; }
        .login-subtitle { text-align: center; color: var(--text-secondary); margin-bottom: 2rem; }

        .input-group { position: relative; margin-bottom: 1.25rem; }
        .input-group input {
            width: 100%;
            padding: 0.75rem 0.75rem 0.75rem 2.5rem;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            background: var(--bg-primary);
            color: var(--text-primary);
        }
        .input-icon { position: absolute; left: 0.75rem; top: 50%; transform: translateY(-50%); }

        /* Buttons */
        .btn-primary, .btn-secondary, .btn-danger, .btn-warning, .btn-outline {
            display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem;
            padding: 0.625rem 1.25rem;
            border-radius: var(--radius-lg);
            font-weight: 500;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
        }
        .btn-primary { background: var(--primary-600); color: white; width: 100%; }
        .btn-primary:hover { background: var(--primary-700); }
        .btn-secondary { background: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border-color); }
        .btn-danger { background: var(--danger-500); color: white; }
        .btn-warning { background: var(--warning-500); color: white; }
        .btn-outline { background: transparent; border: 1px solid var(--border-color); color: var(--text-secondary); }

        /* Dashboard Header */
        .crm-container-modern { display: none; }
        .header-controls { 
            display: grid; grid-template-columns: 1fr auto; gap: 1.25rem; align-items: center; margin-bottom: 2rem; 
            background: var(--bg-primary); padding: 1rem; border-radius: var(--radius-xl); border: 1px solid var(--border-color);
        }
        .header-title-group { display: flex; flex-direction: column; gap: 0.35rem; }
        .header-title {
            display: flex; align-items: center; gap: 0.75rem; flex-wrap: wrap;
            font-size: 2.1rem; font-weight: 700;
        }
        .header-subtitle { color: var(--text-secondary); font-size: 0.95rem; }
        .version-badge { background: var(--primary-100); color: var(--primary-700); padding: 0.15rem 0.5rem; border-radius: 99px; font-size: 0.65rem; }
        .header-actions { display: flex; gap: 0.75rem; align-items: center; }
        .header-actions .btn-primary { width: auto; }
        .btn-outline-danger { background: transparent; border: 1px solid var(--danger-500); color: var(--danger-600); }
        .btn-outline-danger:hover { background: var(--danger-500); color: white; }

        /* Config Section */
        .daily-config-section { margin-bottom: 1.5rem; }
        .daily-config-card {
            background: var(--bg-primary); border: 1px solid var(--border-color);
            border-radius: var(--radius-xl); padding: 1.5rem;
        }
        .config-header { display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem; }
        .config-icon { font-size: 1.5rem; }
        .config-inputs { display: flex; gap: 1rem; align-items: flex-end; flex-wrap: wrap; }
        .input-group.compact { margin-bottom: 0; min-width: 150px; }
        .input-group.compact label { font-size: 0.875rem; display: block; margin-bottom: 0.25rem; }
        .daily-summary { margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border-color); display: flex; gap: 2rem; }
        .summary-status { font-weight: 600; color: var(--warning-500); }
        .summary-status.status-success { color: var(--success-600); }

        /* Metrics */
        .metrics-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem; margin-bottom: 2rem;
        }
        .metric-card {
            background: var(--bg-primary); border: 1px solid var(--border-color);
            border-radius: var(--radius-xl); padding: 1.5rem;
            position: relative; overflow: hidden;
            transition: transform 0.2s, box-shadow 0.2s;
            min-height: 260px;
        }
        .metric-card:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); }
        .metric-card::before {
            content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px;
        }
        .visits-card::before { background: var(--primary-500); }
        .transfers-card::before { background: var(--success-500); }
        .goal-card::before { background: var(--warning-500); }
        .summary-card::before { background: #8b5cf6; }

        .metric-header { display: flex; gap: 0.75rem; margin-bottom: 1rem; }
        .metric-icon { font-size: 1.5rem; background: var(--bg-secondary); padding: 0.5rem; border-radius: 0.5rem; }
        .metric-title { display: flex; flex-direction: column; gap: 0.35rem; }
        .metric-title-row { display: flex; align-items: center; justify-content: space-between; gap: 0.5rem; flex-wrap: wrap; }
        .metric-title p { color: var(--text-secondary); font-weight: 500; }
        .metric-status {
            font-size: 0.7rem;
            font-weight: 600;
            padding: 0.2rem 0.6rem;
            border-radius: 999px;
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            letter-spacing: 0.02em;
            text-transform: uppercase;
        }
        .metric-status.in-progress {
            background: #fef3c7;
            color: #b45309;
            border: 1px solid #fcd34d;
        }
        .metric-status.success {
            background: #ecfdf3;
            color: var(--success-600);
            border: 1px solid #bbf7d0;
        }
        .metric-status.neutral {
            background: var(--primary-100);
            color: var(--primary-700);
            border: 1px solid var(--primary-500);
        }
        .metric-number span:first-child { font-size: 2rem; font-weight: 700; display: block; color: var(--text-primary); }
        .metric-subtitle { color: var(--text-secondary); font-weight: 600; }
        .goal-status { color: var(--text-secondary); font-weight: 600; }
        .progress-bar { height: 6px; background: var(--bg-secondary); border-radius: 99px; margin-top: 1rem; overflow: hidden; }
        .progress-fill { height: 100%; border-radius: 99px; transition: width 0.5s; }
        .visits-progress { background: var(--primary-500); }
        .transfers-progress { background: var(--success-500); }
        .goal-progress { background: var(--warning-500); }
        
        /* Stats inside summary */
        .stat-item { display: flex; justify-content: space-between; padding: 0.25rem 0; font-size: 0.9rem; border-bottom: 1px dashed var(--border-color); }
        .stat-item:last-child { border-bottom: none; }
        .stat-value { font-weight: 600; }
        .stat-value.pending { color: var(--danger-500); }
        .stat-value.justified { color: var(--indigo-500); }


        /* Filters & Table */
        .filters-modern {
            background: var(--bg-primary); padding: 1.5rem; border-radius: var(--radius-xl);
            border: 1px solid var(--border-color); margin-bottom: 1.5rem;
        }
        .filters-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-top: 1rem; }
        .filters-grid select, .filters-grid input {
            width: 100%; padding: 0.6rem; border: 1px solid var(--border-color);
            border-radius: var(--radius-lg); background: var(--bg-primary); color: var(--text-primary);
        }
        @media (max-width: 600px) {
            .filters-modern { padding: 1rem; }
            .filters-grid { grid-template-columns: 1fr; }
            .filters-grid select, .filters-grid input { padding: 0.5rem; font-size: 0.95rem; }
        }

        .table-container-modern {
            background: var(--bg-primary); border: 1px solid var(--border-color);
            border-radius: var(--radius-xl); padding: 1.5rem;
        }
        .table-header { display: flex; justify-content: space-between; margin-bottom: 1rem; }
        .table-wrapper { overflow-x: auto; }
        .modern-table { width: 100%; border-collapse: collapse; min-width: 800px; }
        .modern-table th { 
            text-align: left; padding: 1rem; background: var(--bg-secondary); 
            font-size: 0.875rem; color: var(--text-secondary); font-weight: 600;
        }
        .modern-table td { padding: 1rem; border-bottom: 1px solid var(--border-color); font-size: 0.875rem; vertical-align: middle; }
        .modern-table tr:hover { background: var(--bg-secondary); }

        /* Status Badges - Improved Design */
        .status-btn {
            padding: 0.4rem 0.8rem; border-radius: 99px; font-size: 0.75rem; font-weight: 600;
            border: none; cursor: pointer; display: inline-flex; align-items: center; gap: 0.4rem;
            transition: all 0.2s ease; letter-spacing: 0.02em; min-width: 110px; justify-content: center;
        }
        /* Pendiente: Rojo suave */
        .status-btn.pendiente { 
            background: #fef2f2; color: var(--danger-600); border: 1px solid #fecaca; 
        }
        .status-btn.pendiente:hover { background: #fee2e2; }

        /* Realizado: Verde vibrante */
        .status-btn.realizado { 
            background: #f0fdf4; color: var(--success-600); border: 1px solid #bbf7d0; 
        }
        .status-btn.realizado:hover { background: #dcfce7; }

        /* Justificada: √çndigo elegante */
        .status-btn.justificada {
            background: var(--indigo-100); color: var(--indigo-700); border: 1px solid var(--indigo-600);
        }
        .status-btn.justificada:hover { background: #c7d2fe; }

        .cadena-badge {
            background: var(--primary-100); color: var(--primary-700);
            padding: 0.25rem 0.75rem; border-radius: 6px; font-size: 0.75rem; font-weight: 600;
        }
        
        .address-cell {
            color: var(--text-secondary);
            font-size: 0.8rem;
            max-width: 250px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Upload Section */
        .upload-section-modern {
            background: #fffbeb; border: 1px solid #fcd34d; border-radius: var(--radius-xl);
            padding: 1.5rem; margin-bottom: 1.5rem; display: none;
        }

        /* Modal */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.5);
            display: flex; align-items: center; justify-content: center; z-index: 1000;
            backdrop-filter: blur(4px);
        }
        .modal-content {
            background: var(--bg-primary); padding: 2rem; border-radius: var(--radius-xl);
            width: 90%; max-width: 500px; box-shadow: var(--shadow-md);
        }
        .warning-box {
            background: #fff7ed; border: 1px solid #fdba74; color: #9a3412;
            padding: 1rem; border-radius: var(--radius-lg); margin: 1rem 0; font-size: 0.875rem;
        }
        .modal-footer { display: flex; gap: 1rem; justify-content: flex-end; }

        /* Toast */
        .toast-container { position: fixed; top: 1rem; left: 50%; transform: translateX(-50%); z-index: 2000; }
        .toast {
            background: var(--bg-primary); color: var(--text-primary); padding: 0.75rem 1.25rem;
            border-radius: var(--radius-lg); box-shadow: var(--shadow-md); margin-bottom: 0.5rem;
            border: 1px solid var(--border-color); display: flex; align-items: center; gap: 0.5rem;
            animation: slideDown 0.3s;
        }
        @keyframes slideDown { from { transform: translateY(-100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        /* Theme Toggle */
        .theme-toggle {
            position: fixed; top: 1rem; right: 1rem; width: 40px; height: 40px;
            background: var(--bg-primary); border: 1px solid var(--border-color);
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            cursor: pointer; z-index: 100; box-shadow: var(--shadow-sm);
        }

        @media (max-width: 768px) {
            .header-controls { grid-template-columns: 1fr; gap: 1rem; width: 100%; }
            .header-title { font-size: 1.85rem; }
            .header-title-group { width: 100%; }
            .header-actions {
                display: grid;
                grid-template-columns: 1fr;
                gap: 0.75rem;
                width: 100%;
            }
            .header-actions .btn-primary,
            .header-actions .btn-outline-danger {
                width: 100%;
            }
            .table-wrapper { margin: 0 -1rem; }
            .metrics-grid { grid-template-columns: 1fr; }
            .metric-card { padding: 1.25rem; min-height: 240px; }
            .metric-title-row { align-items: flex-start; }
        }
        @media (max-width: 600px) {
            .metric-card { padding: 1rem; min-height: 0; }
            .metric-header { gap: 0.5rem; margin-bottom: 0.85rem; }
            .metric-number span:first-child { font-size: 1.75rem; }
        }
    </style>
</head>
<body>
    <!-- Theme Toggle -->
    <button id="theme-toggle" class="theme-toggle" aria-label="Cambiar tema">
        <span class="theme-icon">üåô</span>
    </button>

    <!-- Toast Container -->
    <div id="toast-container" class="toast-container"></div>

    <!-- Login Container -->
    <div id="login-container" class="container login-container-modern">
        <div class="login-card">
            <div class="login-header">
                <div class="brand-icon">üíä</div>
                <h1>Bienvenido al CRM</h1>
                <p class="login-subtitle">Sistema de Gesti√≥n de Farmacias</p>
            </div>
            
            <form id="login-form" class="login-form">
                <div class="input-group">
                    <input type="email" id="login-email" placeholder="Correo (ej: edward@admin.com)" required>
                    <span class="input-icon">üìß</span>
                </div>
                
                <div class="input-group">
                    <input type="password" id="login-password" placeholder="Contrase√±a (ej: 123456)" required>
                    <span class="input-icon">üîí</span>
                    <button type="button" class="password-toggle">üëÅÔ∏è</button>
                </div>
                
                <button type="submit" class="btn-primary btn-login">
                    <span class="btn-text">Iniciar Sesi√≥n</span>
                    <div class="btn-loader"></div>
                </button>
            </form>
            
            <p id="login-error" class="error-message"></p>
            
            <div class="demo-info">
                <strong>Demo:</strong> edward@admin.com / 123456
            </div>
        </div>
    </div>

    <!-- CRM Container -->
    <div id="crm-container" class="container crm-container-modern">
        <div class="header-controls">
            <div class="header-title-group">
                <div class="header-title">
                    <span>üìä CRM Farmacias</span>
                    <span class="version-badge">v2.8</span>
                </div>
                <p class="header-subtitle">Sistema Unificado de Gesti√≥n</p>
            </div>
            <div class="header-actions">
                <button id="reset-indicators-btn" class="btn-primary" title="Reiniciar indicadores para nuevo mes">
                    <span>Nuevo Mes</span>
                    <span>üîÑ</span>
                </button>
                <button id="logout-btn" class="btn-outline-danger">
                    <span>Cerrar Sesi√≥n</span>
                    <span>üö™</span>
                </button>
            </div>
        </div>

        <!-- Nueva Secci√≥n: Configuraci√≥n de D√≠as Laborales -->
        <section class="daily-config-section">
            <div class="daily-config-card">
                <div class="config-header">
                    <div class="config-icon">üìÖ</div>
                    <div class="config-title">
                        <h3>Configuraci√≥n de D√≠as Laborales</h3>
                        <p>Establece tu progreso diario para calcular objetivos</p>
                    </div>
                </div>
                <div class="config-content">
                    <div class="config-inputs">
                        <div class="input-group compact">
                            <label for="current-work-day">D√≠a Laboral Actual:</label>
                            <input type="number" id="current-work-day" min="1" max="30" value="1" placeholder="Ej: 1">
                            <span class="input-helper">¬øD√≠a del mes?</span>
                        </div>
                        <div class="input-group compact">
                            <label for="pharmacies-per-day">Meta Diaria (Fija):</label>
                            <input type="number" id="pharmacies-per-day" value="16" readonly style="background-color: var(--bg-secondary); cursor: not-allowed; opacity: 0.7;">
                            <span class="input-helper">16 visitas x d√≠a</span>
                        </div>
                        <button id="update-daily-config" class="btn-primary compact">
                            <span>Actualizar</span>
                            <span>üíæ</span>
                        </button>
                    </div>
                    <div class="daily-summary">
                        <div class="summary-item">
                            <span class="summary-label">üìã Meta Acumulada:</span>
                            <span class="summary-value" id="total-daily-goal">16</span>
                        </div>
                        <div class="summary-item status">
                            <span class="summary-label">üéØ Estado:</span>
                            <span class="summary-status" id="daily-status">En progreso</span>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Metrics Dashboard -->
        <section class="metrics-dashboard">
            <div class="metrics-grid">
                <!-- Cobertura de Visitas -->
                <div class="metric-card visits-card">
                    <div class="metric-header">
                        <div class="metric-icon">üë•</div>
                        <div class="metric-title">
                            <div class="metric-title-row">
                                <h3>Cobertura de Visitas</h3>
                                <span class="metric-status in-progress">En progreso</span>
                            </div>
                            <p>Farmacias visitadas vs objetivo</p>
                        </div>
                    </div>
                    <div class="metric-content">
                        <div class="metric-number">
                            <span id="visits-percentage">0%</span>
                            <span class="metric-subtitle" id="visits-count">0 de 0</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill visits-progress" id="visits-progress"></div>
                        </div>
                    </div>
                </div>

                <!-- Cobertura de Transferencias -->
                <div class="metric-card transfers-card">
                    <div class="metric-header">
                        <div class="metric-icon">üì¶</div>
                        <div class="metric-title">
                            <div class="metric-title-row">
                                <h3>Transferencias</h3>
                                <span class="metric-status in-progress">En progreso</span>
                            </div>
                            <p>Pedidos realizados vs objetivo</p>
                        </div>
                    </div>
                    <div class="metric-content">
                        <div class="metric-number">
                            <span id="transfers-percentage">0%</span>
                            <span class="metric-subtitle" id="transfers-count">0 de 0</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill transfers-progress" id="transfers-progress"></div>
                        </div>
                    </div>
                </div>

                <!-- Objetivo 120 Transferencias -->
                <div class="metric-card goal-card">
                    <div class="metric-header">
                        <div class="metric-icon">üéØ</div>
                        <div class="metric-title">
                            <div class="metric-title-row">
                                <h3>Objetivo Mensual</h3>
                                <span class="metric-status success">Meta cumplida</span>
                            </div>
                            <p>Meta: 120 transferencias</p>
                        </div>
                    </div>
                    <div class="metric-content">
                        <div class="metric-number">
                            <span id="goal-remaining">120</span>
                            <span class="metric-subtitle">restantes</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill goal-progress" id="goal-progress"></div>
                        </div>
                        <div class="goal-status" id="goal-status">
                            <span id="goal-percentage">0%</span> completado
                        </div>
                    </div>
                </div>

                <!-- Resumen General -->
                <div class="metric-card summary-card">
                    <div class="metric-header">
                        <div class="metric-icon">üìà</div>
                        <div class="metric-title">
                            <div class="metric-title-row">
                                <h3>Resumen Total</h3>
                                <span class="metric-status neutral">En progreso</span>
                            </div>
                            <p>Estado de la base de datos</p>
                        </div>
                    </div>
                    <div class="metric-content">
                        <div class="summary-stats">
                            <div class="stat-item">
                                <span class="stat-label">Total Farmacias:</span>
                                <span class="stat-value" id="total-pharmacies">0</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Justificadas:</span>
                                <span class="stat-value justified" id="justified-count">0</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Pendientes Reales:</span>
                                <span class="stat-value pending" id="pending-visits">0</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Upload Section -->
        <div id="upload-section" class="upload-section-modern">
            <div class="setup-header">
                <div class="setup-icon">üîß</div>
                <h3>Carga de Datos Inicial</h3>
            </div>
            <div class="setup-content">
                <p>Carga el listado maestro de farmacias actualizado.</p>
            </div>
            <button id="upload-initial-data" class="btn-primary">
                <span>Cargar Listado Maestro</span>
                <span>‚òÅÔ∏è</span>
            </button>
        </div>

        <!-- Filters -->
        <div class="filters filters-modern">
            <div class="filters-header">
                <h3>üîç Filtros</h3>
                <button id="btn-reset-filters" class="btn-secondary">
                    <span>Limpiar</span>
                    <span>üßπ</span>
                </button>
            </div>
            
            <div class="filters-grid">
                <div class="input-group">
                    <input type="text" id="search-box" placeholder="Buscar: nombre, direcci√≥n, cadena... (ej: cruz bucaramanga)">
                    <span class="search-icon">üîç</span>
                </div>
                
                <select id="filter-visitado">
                    <option value="">Estado Visita</option>
                    <option value="Pendiente">Pendiente</option>
                    <option value="Realizado">Realizado</option>
                    <option value="Justificada">Justificada</option>
                </select>
                
                <select id="filter-transferencia">
                    <option value="">Estado Transferencia</option>
                    <option value="Pendiente">Pendiente</option>
                    <option value="Realizado">Realizado</option>
                    <option value="Justificada">Justificada</option>
                </select>
                
                <select id="filter-cadena">
                    <option value="">Todas las Cadenas</option>
                </select>
            </div>
        </div>

        <!-- Data Table -->
        <div class="table-container table-container-modern">
            <div class="table-header">
                <div class="table-info">
                    <h3>üìã Listado de Farmacias</h3>
                    <p id="record-count">Cargando...</p>
                </div>
                <button id="refresh-btn" class="btn-outline">
                    <span>üîÑ</span>
                </button>
            </div>
            
            <div class="table-wrapper">
                <table class="modern-table">
                    <thead>
                        <tr>
                            <th>Farmacia</th>
                            <th>Cadena</th>
                            <th>Direcci√≥n</th>
                            <th class="text-center">Visita</th>
                            <th class="text-center">Transferencia</th>
                        </tr>
                    </thead>
                    <tbody id="pharmacy-table-body">
                        <!-- Content -->
                    </tbody>
                </table>
                
                <!-- Loading -->
                <div id="loading" class="loading-modern">
                    <div class="loader-spinner"></div>
                    <p>Cargando datos...</p>
                </div>
                
                <!-- Empty State -->
                <div id="empty-state" class="empty-state-modern" style="display: none;">
                    <div class="empty-icon">üì≠</div>
                    <h3>Sin resultados</h3>
                    <p>Ajusta los filtros o carga los datos iniciales.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Reset Modal -->
    <div id="reset-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üîÑ Nuevo Mes</h3>
            </div>
            <div class="modal-body">
                <p>¬øReiniciar todos los indicadores a "Pendiente"?</p>
                <div class="warning-box">
                    <p><strong>‚ö†Ô∏è Advertencia:</strong></p>
                    <ul>
                        <li>Se borrar√° el progreso de visitas y transferencias.</li>
                        <li>Las justificaciones tambi√©n se reiniciar√°n.</li>
                        <li>Esta acci√≥n no se puede deshacer.</li>
                    </ul>
                </div>
            </div>
            <div class="modal-footer">
                <button id="confirm-reset" class="btn-danger">Confirmar</button>
                <button id="cancel-reset" class="btn-secondary">Cancelar</button>
            </div>
        </div>
    </div>

    <script type="module">
        /**
         * ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
         * üè• CRM FARMACIAS - UNIFICADO V2.8
         * Correcci√≥n: Carga de 329 Farmacias (Full List)
         * ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
         */

        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { 
            getAuth, 
            signInWithEmailAndPassword, 
            onAuthStateChanged, 
            signOut
        } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            onSnapshot, 
            doc, 
            updateDoc, 
            query, 
            orderBy,
            writeBatch
        } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

        // === CONFIGURACI√ìN FIREBASE ===
        const firebaseConfig = {
            apiKey: "AIzaSyB2glK3jtje7juBG7gMl4bzh6xG_Zz2YNU",
            authDomain: "crm-farmacias.firebaseapp.com",
            projectId: "crm-farmacias",
            storageBucket: "crm-farmacias.appspot.com",
            messagingSenderId: "251276216502",
            appId: "1:251276216502:web:374f708e2ff040192d3e17"
        };

        // === INICIALIZACI√ìN ===
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const pharmaciesCollection = collection(db, 'pharmacies');

        // === CONSTANTES & CONFIG ===
        const MONTHLY_GOAL = 120;
        const DEFAULT_PHARMACIES_PER_DAY = 16;
        
        let dailyConfig = {
            currentWorkDay: 1,
            pharmaciesPerDay: DEFAULT_PHARMACIES_PER_DAY
        };

        function getTotalDailyGoal() {
             return dailyConfig.currentWorkDay * dailyConfig.pharmaciesPerDay;
        }

        // === DOM REFERENCES ===
        const elements = {
            loginContainer: document.getElementById('login-container'),
            crmContainer: document.getElementById('crm-container'),
            loginForm: document.getElementById('login-form'),
            tableBody: document.getElementById('pharmacy-table-body'),
            loadingIndicator: document.getElementById('loading'),
            emptyState: document.getElementById('empty-state'),
            searchBox: document.getElementById('search-box'),
            recordCount: document.getElementById('record-count'),
            btnUpload: document.getElementById('upload-initial-data'),
            uploadSection: document.getElementById('upload-section'),
            filters: {
                visitado: document.getElementById('filter-visitado'),
                transferencia: document.getElementById('filter-transferencia'),
                cadena: document.getElementById('filter-cadena')
            },
            metrics: {
                visitsPct: document.getElementById('visits-percentage'),
                visitsCount: document.getElementById('visits-count'),
                visitsBar: document.getElementById('visits-progress'),
                transfersPct: document.getElementById('transfers-percentage'),
                transfersCount: document.getElementById('transfers-count'),
                transfersBar: document.getElementById('transfers-progress'),
                goalRemaining: document.getElementById('goal-remaining'),
                goalBar: document.getElementById('goal-progress'),
                goalPct: document.getElementById('goal-percentage'),
                total: document.getElementById('total-pharmacies'),
                pending: document.getElementById('pending-visits'),
                justified: document.getElementById('justified-count')
            },
            daily: {
                dayInput: document.getElementById('current-work-day'),
                goalInput: document.getElementById('pharmacies-per-day'),
                btnUpdate: document.getElementById('update-daily-config'),
                statusLabel: document.getElementById('daily-status'),
                totalLabel: document.getElementById('total-daily-goal')
            }
        };

        let allPharmacies = [];
        let unsubscribe = null;

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // üîê AUTENTICACI√ìN
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        onAuthStateChanged(auth, user => {
            if (user) {
                elements.loginContainer.style.display = 'none';
                elements.crmContainer.style.display = 'block';
                initializeCRM();
                showToast(`Bienvenido ${user.email}`, 'success');
            } else {
                elements.loginContainer.style.display = 'block';
                elements.crmContainer.style.display = 'none';
                if (unsubscribe) unsubscribe();
            }
        });

        elements.loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const pass = document.getElementById('login-password').value;
            const btn = e.target.querySelector('button');
            
            try {
                btn.classList.add('loading');
                await signInWithEmailAndPassword(auth, email, pass);
            } catch (error) {
                showToast('Error de credenciales', 'error');
                console.error(error);
            } finally {
                btn.classList.remove('loading');
            }
        });

        document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // üìä L√ìGICA CORE CRM
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        function initializeCRM() {
            loadDailyConfig();
            
            const q = query(pharmaciesCollection, orderBy('nombre'));
            unsubscribe = onSnapshot(q, (snapshot) => {
                elements.loadingIndicator.style.display = 'block';
                
                allPharmacies = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data(),
                    cadena: doc.data().cadena || 'General',
                    visitado: normalizeStatus(doc.data().visitado),
                    transferencia: normalizeStatus(doc.data().transferencia)
                }));

                updateUI();
                elements.loadingIndicator.style.display = 'none';
                
                if (elements.uploadSection) {
                    elements.uploadSection.style.display = allPharmacies.length === 0 ? 'block' : 'none';
                }
            });
        }

        function updateUI() {
            populateCadenaFilter();
            applyFilters();
            updateMetrics();
        }

        function normalizeStatus(status) {
            if (!status) return 'Pendiente';
            const s = status.toLowerCase();
            if (['realizado', 'completed', 'done'].includes(s)) return 'Realizado';
            if (['justificada', 'justified'].includes(s)) return 'Justificada';
            return 'Pendiente';
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // üîç FILTROS Y RENDERIZADO (MEJORADO - INTUITIVO)
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        function applyFilters() {
            // 1. Obtener texto y dividirlo en palabras (tokens)
            const searchText = elements.searchBox.value.toLowerCase().trim();
            const searchTerms = searchText.split(/\s+/).filter(term => term.length > 0);
            
            const fVisita = elements.filters.visitado.value;
            const fTransf = elements.filters.transferencia.value;
            const fCadena = elements.filters.cadena.value;

            const filtered = allPharmacies.filter(p => {
                // 2. Crear un "super string" con todo el contenido buscable
                const pharmacyContent = `${p.nombre} ${p.direccion} ${p.cadena}`.toLowerCase();

                // 3. Verificar si TODAS las palabras buscadas est√°n en el contenido
                const matchSearch = searchTerms.length === 0 || searchTerms.every(term => pharmacyContent.includes(term));
                
                const matchVisita = !fVisita || p.visitado === fVisita;
                const matchTransf = !fTransf || p.transferencia === fTransf;
                const matchCadena = !fCadena || p.cadena === fCadena;
                
                return matchSearch && matchVisita && matchTransf && matchCadena;
            });

            renderTable(filtered);
            elements.recordCount.textContent = `${filtered.length} farmacias`;
        }

        function renderTable(pharmacies) {
            elements.tableBody.innerHTML = '';
            
            if (pharmacies.length === 0) {
                elements.emptyState.style.display = 'block';
                return;
            }
            
            elements.emptyState.style.display = 'none';
            const fragment = document.createDocumentFragment();

            pharmacies.forEach(p => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><strong>${p.nombre}</strong></td>
                    <td><span class="cadena-badge">${p.cadena}</span></td>
                    <td class="address-cell" title="${p.direccion}">${p.direccion}</td>
                    <td class="text-center">
                        ${renderStatusButton(p.id, 'visitado', p.visitado)}
                    </td>
                    <td class="text-center">
                        ${renderStatusButton(p.id, 'transferencia', p.transferencia)}
                    </td>
                `;
                fragment.appendChild(tr);
            });

            elements.tableBody.appendChild(fragment);
        }

        function renderStatusButton(id, field, status) {
            let label, icon;
            if (status === 'Realizado') { label = 'Realizado'; icon = '‚úÖ'; }
            else if (status === 'Justificada') { label = 'Justificada'; icon = 'üõ°Ô∏è'; }
            else { label = 'Pendiente'; icon = '‚è≥'; }
            
            return `
                <button class="status-btn ${status.toLowerCase()}" onclick="toggleStatus('${id}', '${field}', '${status}')">
                    <span>${icon}</span> <span>${label}</span>
                </button>
            `;
        }

        window.toggleStatus = async (id, field, current) => {
            // Ciclo de estados: Pendiente -> Realizado -> Justificada -> Pendiente
            let newVal;
            if (current === 'Pendiente') newVal = 'Realizado';
            else if (current === 'Realizado') newVal = 'Justificada';
            else newVal = 'Pendiente'; // De Justificada vuelve a Pendiente

            const docRef = doc(db, 'pharmacies', id);
            try {
                await updateDoc(docRef, { [field]: newVal });
                showToast(`Estado cambiado a: ${newVal}`, newVal === 'Pendiente' ? 'info' : 'success');
            } catch (e) {
                showToast('Error al actualizar', 'error');
            }
        };

        function populateCadenaFilter() {
            const cadenas = [...new Set(allPharmacies.map(p => p.cadena))].sort();
            const select = elements.filters.cadena;
            const current = select.value;
            select.innerHTML = '<option value="">Todas las Cadenas</option>';
            cadenas.forEach(c => {
                const opt = document.createElement('option');
                opt.value = c;
                opt.textContent = c;
                select.appendChild(opt);
            });
            select.value = current;
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // üìà M√âTRICAS Y OBJETIVOS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        function loadDailyConfig() {
            const saved = localStorage.getItem('crm-daily-config');
            if (saved) {
                const parsed = JSON.parse(saved);
                dailyConfig.currentWorkDay = parsed.currentWorkDay || 1;
                // Forzamos 16 siempre, ignorando lo guardado para cumplir la regla
                dailyConfig.pharmaciesPerDay = DEFAULT_PHARMACIES_PER_DAY;
            }
            if(elements.daily.dayInput) {
                elements.daily.dayInput.value = dailyConfig.currentWorkDay;
                // Aseguramos que el input muestre 16
                elements.daily.goalInput.value = DEFAULT_PHARMACIES_PER_DAY;
                elements.daily.totalLabel.textContent = getTotalDailyGoal();
            }
        }

        elements.daily.btnUpdate?.addEventListener('click', () => {
            dailyConfig.currentWorkDay = parseInt(elements.daily.dayInput.value) || 1;
            // Forzamos 16 al guardar tambi√©n
            dailyConfig.pharmaciesPerDay = DEFAULT_PHARMACIES_PER_DAY;
            localStorage.setItem('crm-daily-config', JSON.stringify(dailyConfig));
            updateMetrics();
            elements.daily.totalLabel.textContent = getTotalDailyGoal();
            showToast('D√≠as laborales actualizados', 'success');
        });

        function updateMetrics() {
            const visited = allPharmacies.filter(p => p.visitado === 'Realizado').length;
            const transferred = allPharmacies.filter(p => p.transferencia === 'Realizado').length;
            
            const visitedJustified = allPharmacies.filter(p => p.visitado === 'Justificada').length;
            const transferredJustified = allPharmacies.filter(p => p.transferencia === 'Justificada').length;
            
            const dailyGoal = getTotalDailyGoal();

            const vPct = dailyGoal > 0 ? Math.min(100, Math.round((visited / dailyGoal) * 100)) : 0;
            const tPct = dailyGoal > 0 ? Math.min(100, Math.round((transferred / dailyGoal) * 100)) : 0;
            const mPct = Math.min(100, Math.round((transferred / MONTHLY_GOAL) * 100));

            elements.metrics.visitsPct.textContent = `${vPct}%`;
            elements.metrics.visitsCount.textContent = `${visited} / ${dailyGoal}`;
            elements.metrics.visitsBar.style.width = `${vPct}%`;

            elements.metrics.transfersPct.textContent = `${tPct}%`;
            elements.metrics.transfersCount.textContent = `${transferred} / ${dailyGoal}`;
            elements.metrics.transfersBar.style.width = `${tPct}%`;

            elements.metrics.goalRemaining.textContent = Math.max(0, MONTHLY_GOAL - transferred);
            elements.metrics.goalBar.style.width = `${mPct}%`;
            elements.metrics.goalPct.textContent = `${mPct}%`;
            
            elements.metrics.total.textContent = allPharmacies.length;
            
            const pendingVisits = allPharmacies.length - (visited + visitedJustified);
            elements.metrics.pending.textContent = pendingVisits;
            
            if (elements.metrics.justified) {
                elements.metrics.justified.textContent = visitedJustified;
            }

            if (visited >= dailyGoal && transferred >= dailyGoal) {
                elements.daily.statusLabel.textContent = 'üéâ ¬°Objetivo Cumplido!';
                elements.daily.statusLabel.className = 'summary-status status-success';
            } else {
                elements.daily.statusLabel.textContent = 'En Progreso';
                elements.daily.statusLabel.className = 'summary-status';
            }
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // ‚òÅÔ∏è CARGA DE DATOS NUEVA (DATA ACTUALIZADA)
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        elements.btnUpload?.addEventListener('click', async () => {
            if (!confirm('¬øSeguro? Esto cargar√° la nueva base de datos.')) return;
            
            elements.btnUpload.classList.add('loading');
            const batch = writeBatch(db);
            
            try {
                const data = parseNewData();
                console.log(`Procesando ${data.length} registros...`);
                
                data.forEach(p => {
                    const ref = doc(pharmaciesCollection);
                    batch.set(ref, {
                        ...p,
                        createdAt: new Date().toISOString()
                    });
                });

                await batch.commit();
                showToast(`Base de datos actualizada: ${data.length} farmacias`, 'success');
                elements.uploadSection.style.display = 'none';
            } catch (e) {
                console.error(e);
                showToast('Error en carga masiva', 'error');
            } finally {
                elements.btnUpload.classList.remove('loading');
            }
        });

        function parseNewData() {
            // NUEVA DATA PROVISTA POR EL USUARIO
            const rawData = `109_CRUZ_VERDE_CALLE_56	Calle 56 # 32 - 67 Cabecera BUCARAMANGA
11684 - DROG.GRANADOS II	CL L35 # 16 A - 65 RINCON DE GIRON - GIRON
12049 - DROG.Y PERF.FELIX	 BUCARAMANGA/ 04 /CR 10 OCC # 45 A¬†
12494 - SKALA	 GIRON / 10. BRR. CAMPESTRE /AV LOS CANEYES # 25¬†
13695 - DROG. Y PERF. OLIMPICA	 BUCARAMANGA/06 (B.SAN RAFAEL) /CR.14 # 3
16603 - DROG.LUZMABE	 FLORIDABLANCA/05(B.SANTA ANA) /CL.8 # 9
16882 - LA COLOMBIA	 BUCARAMANGA/ 07 /CL 33 # 15¬†
17892 - DROG.VITAL	CL 20 C # 24 - 68 SANTA CRUZ - GIRON
18049 - DROG.PERFUMERIA GRANADOS	CL 104 B # 42 A - 48 BRR SAN BERNARDO - FLORIDABLANCA
18519 - DROG.LA 16 DE SAN CARLOS	CR 16 # 1 N - 14 BRR SAN CARLOS - PIEDECUESTA
19327 - DROG.EL REFUGIO	CL 3 AN #¬† 3 B - 22 - PIEDECUESTA
19337 - DROG.EL GALENO DE FLORIDA	CR 7 # 3 - 50 - FLORIDABLANCA
19545 - DROG.UMEFA	CR 6 # 8 - 40 - PIEDECUESTA
19786 - DROG.GRANADOS REPOSO	CL.56 # 14-83 (B.EL REPOSO) - FLORIDABLANCA
20251 - DROG.GRANADOS VIVERO	 FLORIDABLANCA/ 10 BRR CALDAS /CR 33 # 95¬†
20524 - DROG.SAN RAFAEL	 PIEDECUESTA/ 09 BRR SAN RAFAEL /CL 9 # 13¬†
20525 - DROG.LICO	CL 7 # 9 - 86 BRR SAN RAFAEL - PIEDECUESTA
20771 - DROG. UNIFARMA	 PIEDECUESTA/ 10 BRR HOYO GRANDE /CR 6 # 14¬†
20828 - DROG.NUEVO SOL	CL 4 # 7 - 34 - FLORIDABLANCA
21551 - DROG.Y PERFUMERIA EL LAGO	 AV Floridablanca #147-18 EDIF. EQUILIBRIO DE FLORIDABLANCA
21680 - DROGUERIA LA SEPTIMA DE LEBRIJA	CR 7 # 10 - 44 LEBRIJA
21681 - DROG.DIAMANTE II	AV.89 # 23-135(B.DIAMANTE II) - BUCARAMANGA
22534 - DROG.LA 62 DISANCOL	 BUCARAMANGA/ 10 BRR. CONUCOS /CL 62 # 30¬†
23353 - DROG.PINZON Y CIA. LIMITADA	CR 17 # 35 - 62 - BUCARAMANGA
235 - LA CUMBRE	 FLORIDABLANCA/ 06 BRR LA CUMBRE /CR 9 E # 31¬†
23551 - DROG.COMVIDA	CL 35 # 2 A - 77 LA CUMBRE - FLORIDABLANCA
23859 - DROG.Y MISCELANEA DROMISALUD	CL 12 # 9 - 32 LEBRIJA
23876 - DROG.UNIFARMA PLUS	CL.2 # 16-28 MZ.K LC.5 (B.SAN FRANC PIEDECUESTA
24165 - DROG.PAOLA	CR.27 # 19-04(B.SANTA CRUZ) GIRON
24583 - DROG.SUPERVIT LOS PINOS	CL 14 # 34 - 85 BRR PINOS - BUCARAMANGA
24807 - DROG.LA RECETA PLUS	 BUCARAMANGA/ 08 /CL 33 # 29¬†
24925 - DROG.FARMISALUD FLORIDA	TV 127 # 62A - 14 AP 101 P 1 BRR CIUDAD VALENCIA - FLORIDABLANCA
25024 - DROG.J.E.ORTIZ	CR 22 # 35 - 51 - BUCARAMANGA
25382 - DROG.Y PERFUMERIA LA VIRTUD SUCURSA	CL 30 # 10 E - 23 - FLORIDABLANCA
25491 - DROG.NUEVA MULTICLI.DE BUCARAMANGA	CR 29 # 17 - 72 BUCARAMANGA
26043 - DROG. FARMAMESA	SECT.MIRADOR BRISAS DE LA ACUARELA - LOS SANTOS
26121 - DROGUERIA NUEVA AVENIDA	 BUCARAMANGA/04 (B.CAMPOHERMOSO) /CL.45 # 3 OCC
26348 - DROG Y PERFUMERIA HERFRAN	CR 14 A¬† # 1- 40 - BUCARAMANGA
26397 - DROGUERIA INTERMUNDIAL	CR 11 # 12 - 63 LEBRIJA
26428 - DROG.Y MISCELANEA D Y J PLUS	CL 30 # 7 - 81 BRR LA CUMBRE FLORIDABLANCA
26700 - DROGUERIA DORENA	CR.19 # 21-78(B.ALARCON) - BUCARAMANGA
26778 - DROGUERIAS GLOBALFARMA LA CUMBRE	CR 9 E # 28 - 90 BRR LA CUMBRE - FLORIDABLANCA
26881 - DROGUERIA FAMIPLUS	CR 37 # 42 - 111 BRR. CABECERA - BUCARAMANGA
26915 - FARMA CITY LA 12	SRCT C¬† To.10 APTO 101¬† bellavista-FLORIDABLANCA
26915 - FARMA CITY LA 12	SRCT C¬† To.10 APTO 101¬† bellavista-FLORIDABLANCA
27116 - FARMACIA BOTICA EXPRESS	CR 9 # 8 - 75 LC 101 FLORIDABLANCA
27262 - DROGUERIA Y MISCELANEA ALISFA	CR.24 # 85-29(B.DIAMANTE II) - BUCARAMANGA
27508 - DROGUERIA LA CAMPINA	CL 28A # 30 - 33-GIRON
27525 - DROGUERIA PHARMALUC	 FLORIDABLANCA/ 11 BRR LA CUMBRE /CL 28 # 5 E¬†
27725 - DROG.Y CACHARRERIA GRANADOS SAN FRA	 BUCARAMANGA/ 09 /CL 11 # 23¬†
27727 - DROGUERIA GRANADOS SAN PIO	CR 29 # 44 - 80 - BUCARAMANGA
27978 - DROGUERIA Y MICELANEA CARACOLI	CR 6 # 1 - 17 BRR CARACOLI FLORIDABLANCA
28053 - DROGUERIA GRANADOS NUEVO SOTO MAYOR	CL 50 # 23 - 08 BUCARAMANGA
28558 - DROGUERIA SANTA CRUZ PLUS	CR.26 # 17-27 (B.SANTA CRUZ) GIRON
28616 - DROGUERIA LOS ALTOS DEL CACIQUE II	 FLORIDABLANCA/ 03 BRR ALTOS DEL CACIQUE /CL 85 # 56¬†
29153 - DROGUERIA GRANADOS KENNEDY	CL.12 # 17N-05(B.KENEDY) BUCARAMANGA
29398 - DROG.FARMATOTAL MAS FARMACIA MAS SA	 BUCARAMANGA/ 02 BRR DELICIAS ALTAS /CR 16 # 104 B¬†
29736 - DROGUERIA CAMARGO VALENCIA	CR 12 # 14 - 34 .3 ESQ BRR CUIDAD VALENCIA-FLORIDABLANCA
29838 - DROGUERIA MISCELANEA ESPANOLA #2	CR.24 # 87-14(B.DIAMANTE) - BUCARAMANGA
29931 - SU SALUD JB DROGUERIA	CR 24 # 24 - 11 BRR ALARCON BUCARAMANGA
29931 - SU SALUD JB DROGUERIA	CR 24 # 24 - 11 BRR ALARCON BUCARAMANGA
30058 - DROGUERIA OSORIO SUAREZ	 BUCARAMANGA/ 11 BRR EL PRADO /CL 33 # 33A¬†
30105 - DROGUERIA Y MISCELANEA LORCE	CL 30 # 1 - 219 BRR LA CUMBRE - FLORIDABLANCA
30212 - DROGUERIAS LEON S.A.S	CL 105 15B-45 - BUCARAMANGA
30338 - DROGUERIA DAFARMA	GIRON/12/CL 43 # 22
30465 - DROGUERIA Y MISCELANEA CARIOS	FLORIDABLANCA/11 loc 102 bucarica/BL 18
30644 - DROGUERIA FAMY SALUD	AV GUAYACANES BL 9 CD REAL DE MINAS - BUCARAMANGA
31209 - DROGUERIA CLER FLORIDA BLANCA	CR 10A 42-04 EL CARMEN FLORIDABLANCA
31292 - DROGUERIA UNIDAD ASITENCIAL ECOMED	CL 30 # 9 A E - 35 - FLORIDABLANCA
31355 - DROGUERIA EL SEMBRADOR	CR 33 # 86-144 T 1 LC 3 CACIQUE C - BUCARAMANGA
31407 - DROGAS ESQUINA DE LA 56	CLL 56 # 30-122 BUCARAMANGA
31618 - DROGUERIA GRANADOS CENTRO	 BUCARAMANGA/ 03 LC 7 ED UNIDAD RES /CL 37 # 22¬†
31786 - DROGUERIA MEGAMODERNA PLUS 24 - 7	CR 4 # 48 - 07 BRR LAGOS II FLORIDABLANCA
31903 - FARMAHOGAR CENTRAL	MESA DE LOS SANTOS GUAYABAL LC.9 VD MESA DE LOS SANTOS
31996 - DROGUERIA RIONEGRO PLAZA	CL.12 # 10-10 (B. CENTRO) RIONEGRO
32542 - DROGUERIAS GRANADOS DIAMANTE	AV 89 # 23 - 35 - BUCARAMANGA
32717 - FARMACIA LA LUZ DEL PORVENIR	CL 104 F # 8 B - 24 LOCAL 8 BLOQUE 3 B - BUCARAMANGA
32815 - DROGUERIA SUPREMA LA PAZ	CR.8 # 13-77 (B. VIA AL MAR CENTRO) EL PLAYON
33062 - DROGUERIA FARMAVILLAS SAS 3	CR. 13 A # 50-65 (B. VILLA LUZ) - FLORIDABLANCA
33137 - DROGUERIA VELE√ëO	 SAN ALBERTO/04 (B. VILLA FANNY) /CL 2 # 4
33243 - DROGUERIA Y MINIMARKET GRAND BOULEV	CR.20 # 16-56 ET.2 TORRE 2 LC.24 BRR. SAN FRANCISCO BUCRAMANGA
33395 - FARMACIUDADELA	CL 57 # 16 - 60 BRR GOMEZ NINO - BUCARAMANGA
33433 - DROGUERIA SANTAFE SALUD	 FLORIDABLANCA/ 08¬† BRR SANTA FE /CR 42 # 107¬†
34192 - DROGUERIA GRANADOS 5	 BUCARAMANGA/ 06 /CR 27 # 18¬†
34290 - DROGUERIA JEREZ PASEO DEL PUENTE II	 PIEDECUESTA/04 /CR 5B # 22
34519 - FAMIRSALUD OASIS	 FLORIDABLANCA/06 BARRIO EL OASIS /DG 17 #55
34632 - DROGUERIA Y PERFUMERIA FAMAVILLAS	 BUCARAMANGA/04 /Cl. 105 #15B
34840 - DROGUERIA SANEDIL	CR.24 # 31-04 (B. ANTONIA SANTOS) BUCARAMANGA
34842 - DROGUERIA GRANADOS MUTIS 2	 BUCARAMANGA/04 /CL 59 # 3W
34847 - DROGUERIA SUPER DROGUERIA S.C	CR.22 # 32-03 (B. ANTONIA SANTOS) BUCARAMANGA
34847 - DROGUERIA SUPER DROGUERIA S.C	CR.22 # 32-03 (B. ANTONIA SANTOS) BUCARAMANGA
34853 - PHARMALIS DROGUERIA	 BUCARAMANGA/02¬† BRR EL GIRARDOT /CR 5 # 28
34867 - DROGUERIA CLER	CL 197 # 28 - 62 BRR RECREO - FLORIDABLANCA
34870 - DROGUERIA FARMA GOMEZ MATIAS	 FLORIDABLANCA/ 09 BRR VALENCIA /CR 12 # 8¬†
34876 - DROGUERIAFAMYSALUD 	CR 3 # 61 - 27 - BUCARAMANGA
34965 - DROGUERIA BUCARICA	 FLORIDABLANCA/3 LOC 101 SECTOR 12 BUCARICA/BL 20
35015 - FARMACLUB 2	CL 52 # 35 A - 40 - BUCARAMANGA
35266 - DROGUERIA MEDICAM PLUS	CR 6 # 14 - 90 - PIEDECUESTA
35280 - DROGUERIA GRANADOS SAN FRANCISCO PL	CL 13 # 21 - 48 SAN FRANCISCO - BUCARAMANGA
35286 - DROGUERIA NUEVA LUZ	Dg. 45 # 109A-26 - FLORIDABLANCA
35540 - DROGUERIA GRANADOS EL PUENTE	CR 6 # 19-13 - PIEDECUESTA
36127 - DROGUERIA ECOVIDA	CR 15 # 8 - 22 - PIEDECUESTA
36217 - DROGUERIA SUPERDROGAS LEBRIJA	CL 12 # 8 - 12 LEBRIJA
36557 - DROG. PHARMADESCUENTOS LA UNIVERSID	 BUCARAMANGA/ 02 BRR LA UNIVERSIDAD /CR 25 # 9¬†
36779 - DROGUERIA EL ATRIO	CR. 3A # 7N-36(B. JUNIN 1) PIEDECUESTA
36881 - DROGUERIA UNICENTRO	CL.18 # 25-114 (B.PORTAL CAMPESTRE) GIRON
37652 - DROGUERIA ZAMBRANO PLUS	CL. 31 # 20 -17 (B. CENTRO) BUCARAMANGA
37652 - DROGUERIA ZAMBRANO PLUS	CL. 31 # 20 -17 (B. CENTRO) BUCARAMANGA
37753 - DROGUERIA FARMACLARO	CR 3 # 58-17 LOS NARANJOS - BUCARAMANGA
37992 -DROGUERIA LA FLORESTA PLUS	CR 22#54-50 BUCARAMANGA
38008 - DROGUERIA EL DEPOSITO CENTRO	CL 36 # 13 - 27 BRR CENTRO - BUCARAMANGA
38009 - DROGUERIA EL DEPOSITO	CR 21 # 54-34¬† LA CONCORDIA - BUCARAMANGA
38812 - DROG.Y PERF.SOTOMAYOR	 BUCARAMANGA/03(B.SOTOMAYOR) /CL.48 # 26
39199 - SUPERDROGUERIA LA MEJOR	CL 11 # 7 - 11 LEBRIJA
39216 - DROGUERIA GRANADOS LA OCTAVA	CL.6 # 8-10(B.CASCO ANTIGUO FLORIDA FLORIDABLANCA
40369 - FARMACIA Y DROGUERIA SAN JUAN DE GI	CR 26 # 28 - 05 GIRON
40535 - DROGUERIA FARMASAYE	CR.8 # 8-43 (B. CASCO ANTIGUO) FLORIDABLANCA
40622 - DROGUERIA GRANADOS AMIGA	CL 10 # 5 - 57 - PIEDECUESTA
40961 - DROGUERIA J - MAX	CR 1W # 5AN - 15 MZ 31(B. REFUGIO) PIEDECUESTA
41806- DROGUERIA BOSQUES DE ARANJUEZ	CR 4 # 1 N B - 10 (B. BOSQUES DE ARANJUEZ) PIEDECUESTA
983_FARMACIA_INTERNA_CRUZ_VERDE_CLINICA SAN LUIS	CL 48 # 25 - 56 BUCARAMANGA
ALEMANA 08	CL 60 # 9 - 109 T 4 L 7 - 8 TO SAN REMO BUCARAMANGA
ALEMANA 12	CR 18 # 34 - 01 BUCARAMANGA
ALEMANA 26 LA FOSCAL	TV 154 # 150 - 207 BRR BOSQUE FLORIDABLANCA
ALEMANA 355	CALLE 30 # 25-71 CC CA√ëAVERAL LOC 106 FLORIDABLANCA
ALEMANA 356	CR. 26 # 42-29 GIRON
ALEMANA 58	CR 6 # 9 - 40 piedecuesta
DROGUERIA 306 FARMASOLANO	CR 22 # 21 - 79 BUCARAMANGA
DROGUERIA AHORRA MAX	CL 3 AN # 30 - 09 BRR EL REFUGIO - PIEDECUESTA
DROGUERIA AHORRAMEDIC	CL 52 # 31 - 104 BRR CABECERA - BUCARAMANGA
DROGUERIA ANGY MAR	AV GUAYACANES T-19 L101 CIUDAD BOLIVAR BUCARAMANGA
DROGUERIA ANTOLINEZ	CR 2W # 59 - 23 MUTIS - BUCARAMANGA
DROGUERIA BLANTONY	CL 60 # 9 - 103 BRR CIUDADELA - BUCARAMANGA
DROGUERIA BULEVAR	CL 18 # 21 - 74 BUCARAMANGA
DROGUERIA CAMELOT	CLL 8N #3 -190 LOCAL 4 GUATIGUARA PIEDECUESTA
DROGUERIA CAMPO HERMOSO	CL 45 # 5 OCC - 10 BUCARAMANGA
DROGUERIA CARMENCITA	CL 30 # 29 B - 11 FLORIDABLANCA
DROGUERIA CONSULTORIO 2 CONSULTORIO ALIRIO LOPEZ NO. 2	CL 30 # 7 E - 95 LA CUMBRE FLORIDABLANCA
DROGUERIA CRUZ VERDE CA√ëAVERAL	CL 30 # 25-71 CENTRO COMERCIAL CA√ëAVERAL LOCAL 31 FLORIDABLANCA
DROGUERIA DANNYS	SANANDRESITO ISLA LC 7 - 31 P 3 - BUCARAMANGA
DROGUERIA DISERVAL	CL 31 #28-74 B. LA AURORA BUCARAMANGA
DROGUERIA DISTRIBUIDORA EL NILO	CC SAN ANDRESITO ISLA P 1 L 7 - 28 Y 7 - 29 - BUCARAMANGA
DROGUERIA DISTRIBUIDORA SANDRA C	CC SAN ANDRESITO ISLA P 3 L 8 - 35 Y 8 - 33 - BUCARAMANGA
DROGUERIA EL CARMEN - BUCARAMANGA	 BUCARAMANGA/02¬† BRR EL GIRARDOT /CL 28 #6
DROGUERIA EL DUENDE	 KILOMETRO 9 VIA CUROS - LOS SANTOS (MUNICIPIO LOS SANTOS)
DROGUERIA EL PAISA	CRA 15 # 56 CC SANADRESITO ISLA LC 7 - 8 BUCARAMANGA
DROGUERIA EL SEGURO	CR 31 # 27 - 48 BUCARAMANGA
DROGUERIA FARMA EXPRESS	CR 6 #27-02¬† BRR EL GIRARDOT BUCARAMANGA
DROGUERIA FARMA GOMEZ	CR 7#29-15 BRR EL GIRARDOT BUCARAMANGA
DROGUERIA FARMACIA SALUD FAMILIAR	CL 33 # 16 - 34¬† PLAZA DE MERCADO CENTRO BUCARAMANGA
DROGUERIA FARMAMEDICA MUTIS	CR 7W#59-22 BUCARAMANGA
DROGUERIA FARMAMETROPOLIS 	CR 8 # 61 - 137 L7 BRR METROPOLIS-BUCARAMANGA
DROGUERIA FARMASOLANO	CL 59 # 18 - 31 BRR TRINIDAD FLORIDABLANCA
DROGUERIA FIORELLA	CR 21 B # 111 - 124 - BUCARAMANGA
DROGUERIA GRANADOS CAFASAN 	 FLORIDABLANCA/ 02 CALDAS/CR 37 # 109¬†
DROGUERIA KOLSUDROGAS	CL 39 # 22 - 30 GIRON
DROGUERIA LA SEPTIMA PIEDECUESTA	CL 7 # 10 - 99 PIEDECUESTA
DROGUERIA LEBRI FARMA	CL 12 # 13 A - 25 LEBRIJA
DROGUERIA LORENA	CR 7 # 10 - 38 PIEDECUESTA
DROGUERIA M Y D	CR #¬† 53 - 03¬† BRR EL RECREO FLORIDABLANCA
DROGUERIA MARIA REYNA	CL 27 #6-44¬† BRR EL GIRARDOT BUCARAMANGA
DROGUERIA MULTIFARMA #1	CL 105 # 29A - 21-FLORIDABLANCA
DROGUERIA MX ALKOSTO	CR 13 # 103 B - 46 BRR SAN FERMIN BUCARAMANGA
DROGUERIA NAYIBE	CLL 4 #8-31 FLORIDABLANCA
DROGUERIA NUEVA SAN CARLOS	CR 25 # 13 - 28 BRR SAN FRANCISCO
DROGUERIA PAGUE MENOS GIRON	CL 43 # 22 - 92 - GIRON
DROGUERIA PAGUE MENOS PIEDECUESTA	CR 8 # 7 - 77 - PIEDECUESTA
DROGUERIA PAGUE MENOS SAN FRANCISCO	BLV # 23 - 03 - BUCARAMANGA
DROGUERIA PAGUE MENOS SOTOMAYOR	CL 54 # 24 - 03 - BUCARAMANGA
DROGUERIA PALENQUE	CR 19 # 56 - 58. BRR EL PALENQUE - GIRON
DROGUERIA PHARMACY	AV EL BOSQUE # 54 - 52 FLORIDABLANCA
DROGUERIA PINZON 2	CR 38 # 49 - 15 BUCARAMANGA
DROGUERIA PROVIDA	CR 22 # 110 - 44 - BUCARAMANGA
DROGUERIA QUINTA REAL LAS PALMAS	CR 15 # 6 N - 03 - PIEDECUESTA
DROGUERIA REBAJA PLUS 9 CACIQUE	AV CRV # 35 - 95 FLORIDABLANCA
DROGUERIA SAN LUIS - BUCARAMANGA	CL 48 # 26 - 19 BRR SOTOMAYOR - BUCARAMANGA
DROGUERIA SAN PABLO	CR 22 # 11 - 81 BRR SAN FRANCISCO - BUCARAMANGA
DROGUERIA SANTA CECILIA	CL 21 # 23 - 75 BUCARAMANGA
DROGUERIA SILVA 	FLORIDABLANCA/09/Cl. 57 #3
DROGUERIA SOLETH	CR. 6 #28-65(B.GIRARDOT) BUCARAMANGA
DROGUERIA SUPERDROGAS CONUCOS	CL 58 # 29 - 31 LOCAL 5 BUCARAMANGA
DROGUERIA VIDA LTDA	CR 32 # 30A - 20 BRR. AURORA-BUCARAMANGA
DROGUERIA VILLABEL 	FLORIDABLANCA/ 04/CR 11 # 12¬†
DROGUERIA Y CACHARRERIA AYS	CC SAN ANDRESITO ISLA P 3 L 8 - 36 - BUCARAMANGA
DROGUERIA Y DISTRIBUCIONES ABASTOS XIMENA	DG 15 # 55 - 56 L F - 02 CC SAN ANDRESITO LA ISLA - BUCARAMANGA
DROGUERIA Y PERFUMERIA ANTIOQUE√ëA	DG 105 # 30B - 13 SATELITE-FLORIDABLANCA
DROGUERIAS JEREZ VILLABEL	CR 12 # 7 - 11 FLORIDABLANCA
EL FARMACEUTA	CL 103 NO. 13B-79-BUCARAMANGA
FARMACIA 1A	BUCARAMANGA/04 LOC 1/CR 15 103
FARMACIA SAN MIGUEL	VIA PIEDECUESTA LOS SANTOS CONDOMINIO MESA DE LOS SANTOS LOCAL 3 - LOS SANTOS
JEREZ	CR 15 E No. 105-61-BUCARAMANGA
MANUELA BELTRAN	CR 13 #104C-34-BUCARAMANGA
PUNTO FARMACEUTICO	CLL 63 #17E-01B - BUCARAMANGA
REBAJA No. 11 BUCARAMANGA RICAURTE	CL 56 # 17 C - 12 BUCARAMANGA
REBAJA PLUS No. 12 BUCARAMANGA PASAJE DE COMERCIO	CR 17 # 35 - 13 - BUCARAMANGA
REBAJA PLUS No. 2 BUCARAMANGA CIUDADELA REAL DE MINAS	AV SAMANES # 9 - 75 BUCARAMANGA
REBAJA PLUS No. 8 BUCARAMANGA LAS DELICIAS	CL 105 # 15 D - 03 BUCARAMANGA
DROGUERIA SANTA LUCIA	CR 6 # 42 - 13 LAGOS II FLORIDABLANCA
29094 - DROGUERIA GRANADOS MENDOZA	CR 6 # 43 - 18 LOCAL 2 BRR LAGOS II FLORIDABLANCA
DROGUERIA PHARMALAGOS	CL 29 # 7 - 08 LAGOS 3 FLORIDABLANCA
30986 - MAFCONT DROGUERIAS EL LAGO I	Cl. 29 #11-126 FLORIDABLANCA
1022_CRUZ_VERDE_CARACOL√ç	Carrera 27 # 29 ‚Äì 145 Local 408 FLORIDABLANCA
10680 - ALTAMIRA	CR 5 # 94 - 62 - FLORIDABLANCA
23250 - DROG.Y PERFUMERIA JAEL	CL 7 # 10 - 58 - FLORIDABLANCA
26177 - GRANADOS LIMONCITO	 FLORIDABLANCA/09 /CR 15 # 6
27726 - DROGUERIA GRANADOS BUCARIA	FLORIDABLANCA/4 local 101/BLOQUE 14
DROGERIA TAYSOFI	CR 7 # 5 - 06 AV CARACOLI - FLORIDABLANCA
SUPERNOVA	CR 40 203-28-FLORIDABLANCA
LA Y	AV BUCARICA T8-1 FLORIDABLANCA
DROGUERIA SERVIFARMA	SECTOR 9 BL 16 - 7 FLORIDABLANCA
DROGUERIA BLANCO	CR 6 # 39 - 26 LAGOS II FLORIDABLANCA
DROGUERIA FLORIDA	CR 8 # 7 - 53 BRR CENTRO FLORIDABLANCA
41878 - DROGUERIA FARMATECUIDA	CL. 20 C # 19 - 03 (B. PORTAL CAMPE) GIRON
34098 - DROGUERIA FARMASED	CL 14C #11-98 ALMENARES DE SAN GIRON - GIRON
DROGUERIA LAS PRIMICIAS	CL 14B # 12A-76 VILLAS DE DON JUAN¬† GIRON
34317 - DROGUERIA FARMASED 2	 GIRON/02 LC 2 /CR 13 # 13C
DROGUERIA VALERY	CR 23 # 7A-04 BR. MIRADOR ARENALES GIRON
DROGUERIA SANA SANAR	CL 10B # 20 - 04 -LAS VILLAS - GIRON
DROGUERIA LAS VILLAS	CL 10B # 22 - 09 GIRON
DROGUERIA LAS VILLAS DE SAN JUAN	CL 10b # 24A - 16 BRR. SAN JUAN DE GIRON GIRON
36979 - DROGUERIA Y PERFUMERIA SAN FELIPE	CL.117 # 27-60 (B.NIZZA) - FLORIDABLANCA
DROGUERIA LA GENERICA	CL 113 #32-43 LC 17 T0RRES DEL BICENTENARIO FLORIDABLANCA
33231 - DROGUERIA VGA 	CL 113 # 32 - 79 COND T DEL BICENTENARIO - FLORIDABLANCA
FARMASAY	CR 33 # 111-13 FLORIDABLANCA
ALBA LUZ	CR 33 109-36 FLORIDABLANCA
27134 - DROGUERIA PERFUMERIA ECONOMICA	DG.105 # 31-16 LC. 13 PLAZA SATELITE - FLORIDABLANCA
PHARMA PROVENZA	CL 105 # 23-135 BUCARAMANGA
REBAJA PLUS No. 1 BUCARAMANGA PROVENZA	CL 105 # 22 - 83 BRR PROVENZA BUCARAMANGA
DROGUERIA PAGUE MENOS PROVENZA	CL 105 # 21 - 139 - BUCARAMANGA
REBAJA PLUS 5 FLORIDABLANCA	CR 8 # 4 - 76 FLORIDABLANCA
18745 - DROG.JACOME Y MISCELANEA	CR 33 # 52 - 145 - BUCARAMANGA
COOFARMA 5	CR 33 # 52 B - 18 BUCARAMANGA
ALEMANA 178	CR 33 # 52 B - ESQ BRR CABECERA BUCARAMANGA
DROGUERIA PAGUE MENOS CABECERA	CR 35 # 52 - 88 - BUCARAMANGA
634_CRUZ_VERDE_CABECERA DEL LLANO	Carrera 33 # 46 - 61 BUCARAMANGA
33243 - DROGUERIA Y MINIMARKET GRAND BOULEV	CR.20 # 16-56 ET.2 TORRE 2 LC.24 BRR. SAN FRANCISCO BUCRAMANGA
13695 - DROG. Y PERF. OLIMPICA	 BUCARAMANGA/06 (B.SAN RAFAEL) /CR.14 # 3
DROGUERIA ASILO	CALLE 2 # 14A-123 BUCARAMANGA
20816 - DROG.NUEVO MILENIO II	CR.12 # 19-30(B.KENNEDY) BUCARAMANGA
19159 - DROG.Y PERFUMERIA DROGFARMA	 BUCARAMANGA/ 12 BRR ALARCON /CL 28 # 19¬†
TODO SALUD	CR 26 #31-70 BUCARAMANGA
REBAJA PLUS No. 4 BUCARAMANGA GUARIN	CR 33 # 30 A - 09 BUCARAMANGA
REBAJA PLUS No. 6 BUCARAMANGA SAN ALONSO	CR 30 # 14 - 06 BUCARAMANGA
DROGUERIA UNIVERSIDAD	CR 26 A # 10 - 18 BUCARAMANGA
DROGUERIA PAGUE MENOS FLORIDABLANCA	CR 8 #¬† 4 - 48 Y 52 FLORIDABLANCA
DROGUERIA SUPERVIDA	CR 8 # 3 - 49 AGUACHICA
DROGUERIA UNICA	CR 15 # 3 - 34 PUERTO MADERO PIEDECUESTA
19178 - SUPERDROGAS PIEDECUESTA	CR 15 # 3 - 34 PUERTO MADERO - PIEDECUESTA
DROGUERIA MEDIEXPREESS	CR 15 # 3 - 166 BRR PUERTO MADERO PIEDECUESTA
DROGUERIA MEDIFARMA	CR 4 # 1 B -28 CAMPO VERDE PIEDECUESTA
DROGUERIA JEREZ SAN RAFAEL	CR 15 # 7 - 14 SAN RAFAEL PIEDECUESTA
30250 - DROGUERIA MOLINOS DEL VIENTO	CR.16 # 14-68(B.MOLINOS DEL VIENTO) - PIEDECUESTA
28819 - DROGUERIA RIVERA PHARMA M	 PIEDECUESTA/ 04 BRR PASEO DEL PUENTE II /CR 4 # 21¬†
DROGUERIA ECOFARMA	CR 2 C # 21 - 04 BRR PASEO DEL PUENTE II PIEDECUESTA
32718 - DROGUERIA CAMARGO	CR 2 N # 21 - 16 BRR PASEO DEL PUENTE 2 - PIEDECUESTA
32820 - DROGUERIA SALUD Y BELLEZA	AV 17 #2W-144 BRR BARRO BLANCO - PIEDECUESTA
31359 - DROGUERIA Y MISCELANIA SALBE	AV17 # 15A-16 BRR BARRO BLANCO - PIEDECUESTA
EKONOFARMA	CR 4 No- 0-20 LOC 1 PALERMO 1- PIEDECUESTA¬†
ALEMANA 160	CL 200 # 13 - 08 LC 3 ED MONTESOL FLORIDABLANCA
DROGUERIA PAGUE MENOS CA√ëAVERAL	CL 33 # 26 - 27 CA√ëAVERAL - FLORIDABLANCA
ALEMANA 60	CR 26 # 30 - 28 BRR CA√ëAVERAL FLORIDABLANCA
831_CRUZ_VERDE_CC_CACIQUE	Transversal 93 # 34 -99 Local 371 y 372 BUCARAMANGA
DROGUERIA ALEMANA 32 CACIQUE	TV ORIENTAL # 35¬† - 254 MIRADOR DEL CACIQUE BUCARAMANGA
174_CRUZ_VERDE_PARQUE_TURBAY	CR 28 # 48-60 BUCARAMANGA
26880 - DROGAS CHICAMOCHA	CR 27 A # 40 - 35 BRR MEJORAS PUBLICAS - BUCARAMANGA
27700 - DROGUERIA FARMAKOS	CR 33 # 41 - 24 BUCARAMANGA
294_CRUZ_VERDE_JUMBO_CABECERA_TIENDA	CR 33 # 41 - 34 BUCARAMANGA
444_DROGUERIA_CRUZ_VERDE_CARRERA_33	Carrera 33 # 41 - 45 BUCARAMANGA
36385 - DROGUERIA Y PERFUMERIA VIVIR	CL 32 # 33 A - 54 - BUCARAMANGA
33063 - DROGUERIA FARMAVILLAS 2	 BUCARAMANGA/ ESQ BRR ALVAREZ /CL 32 # 38¬†
DROGUERIA ALVAREZ	CR 38 # 32 - 121 - BUCARAMANGA
19643- DROGAS CENTRAL DESCUENTOS BUCARAMAN	CL 34 # 34 C - 61 BRR ALVAREZ - BUCARAMANGA
27134 - DROGUERIA PERFUMERIA ECONOMICA	CR 26 # 33-96 ESQ. BUCARAMANGA
REBAJA PLUS No. 3 BUCARAMANGA SOTOMAYOR	CR 27 # 41 - 02 BUCARAMANGA
REBAJA PLUS No. 14 BUCARAMANGA DIAMANTE II	Carrera 26 No. 85-44 BUCARAMANGA
REBAJA PLUS No. 1 FLORIDABLANCA CANAVERAL	CL 30 # 26 - 10¬† FLORIDABLANCA
DROGUERIA FOSCAL	CR 24 # 154 - 106 URB EL BOSQUE - FLORIDABLANCA
VICTORIA DE LOS REYES	CL 67 18-25-BUCARAMANGA
DROGUERIA CENTRAL DESCUENTOS	CL 67 # 17 - 14 BRR LA VICTORIA - BUCARAMANGA
LA VICTORIA	BUCARAMANGA/07/CL 67 13
36861 - HIPERFARMACIA AG	CR 11 67 -93 - BUCARAMANGA
16201 - DROG.GRANADOS PABLO VI	CL 11 # 68 - 24 CENTRO - BUCARAMANGA
DROGUERIA LINEAVITAL	CR 10E # 67 - 42 PABLO VI BUCARAMANGA
28998 - DROGUERIA PERFUMERIA HL	CR 4 # 4 - 39 - SAN ALBERTO
DROGUERIA PHARMATODO	Cl 4 # 4-1, San Alberto, Cesar
DROGUERIA FARMASALUD UNIVERSAL	CR 8 #16-02 SAN MARTIN
DROGUERIA CASTILLO	CR 7 # 14-12 SAN MARTIN
25211 - DROGUERIA SERVIC D	CR 7 # 14 - 26 (B. CENTRO) - SAN MARTIN
18202 - DROGUERIA SUPERDROGAS PARRA	Cra 8 # 9-51 - PELAYA
DROGUERIA JUSTY MORENO	Cl. 12 #10-1, Pelaya, Cesar
37491 - DROGUERIA MAXIDROGAS	CL.6 # 16-66 LC.3 (B.OLYA HERRERA) - AGUACHICA
26797 - DROGUERIA LA CURITA PLUS 2	CL 5 # 22 - 85 - AGUACHICA
36061 - MAS X MENOS	CL 5 # 29-52 - AGUACHICA
42088 - CURITA PLUS DROGUERIA	CR 15 # 5 - 02 - AGUACHICA
29388 - DROGUERIA BENDITA PLUS	CL.6 # 8-04 (B.ARAUJO) GAMARRA
10933 - DROGUERIA SAN JORGE - AGUACHICA	CL 5 # 15 - 90 - AGUACHICA
29088 - DROGUERIA PAGUE MENOS LA QUINTA	CL 5 # 17 - 90 - AGUACHICA
DROGUERIA SALUD Y BELLEZA AGUACHICA	CL 5 # 19-43 AGUACHICA
PROVEEDORA RICHARD	CL 5#24A-54 AGUACHICA
DROGUERIA TOTAL CONFIANZA	Cl. 12 #10-24 SANTA CLARA OCA√ëA
DROGUERIA RIA√ëO	CR 49 N¬∞ 5-06 SANTA CLARA OCA√ëA
40811 - DROG SANTA CLARA 	CR.55B # 24-49 (B.SAN ANTONIO) RIONEGRO
40336 - DROGUERIA X SANTA CLARA	CL 5A # 48-75 SANTA CLARA
40159 - DROGUERIA LA X 5	 OCA√ëA/03(B.LAS LLAMADAS) /CL 7 # 26
21821 - DROGUERIA AVENIDA OCA√ëA	CL 7 # 28 - 55 BRR PRIMAVERA - OCA√ëA
30494 - DROGUERIA BETEL	Cl. 11 #16a 21 local 3 - OCA√ëA
DROGUERIA LA NUEVA	CR 14 # 8 A - 25 OCA√ëA
DROGUERIA MEGAFARMA OCANA	CR.14 # 8-18(B.MERCADO) OCA√ëA
DROGUERIA Y AUTOSERVICIO 20-20	CR.13 # 8-47 (B.DULCE NOMBRE) OCA√ëA
27900 - DROGUERIA LA 10 OCA√ëA	CL 10 # 14 - 81- OCA√ëA
42179 - DROGUERIA MAXIDROGAS ABREGO	CL. 18 # 4 - 02 (B. SANTA BARBARA) - ABREGO
29567 - DROGUERIA FARMAPAEZ	CR 5 # 12-73J (B.CALLE REAL) - ABREGO
32268 - DROGUERIA PHARMAKOS	CR 6 # 12-14 (B. CALLE CENTRAL) - ABREGO
40459 - DROGUERIA SANTA ISABEL	CR.6 # 13 - 64 (B. CENTRO) - OCA√ëA
DROGUERIA PAGUE MENOS	CR 6 CL 13¬† Abrego, Norte de Santander
42213 - DROGUERIA UNIDROGAS EDGOSA SAFME	CR 6 # 15-31 ESQUINA ABREGO ABRERO
27760 - DROGUERIA PAGUE MENOS OCA√ëA	CR 11 # 12 - 02 - OCA√ëA
34567 - DROGUERIA LA 13 OCA√ëA	CR 13 # 11 - 56 - OCA√ëA
21812 - DROGUERIA OCA√ëA	CL 11 # 13 - 69 - OCA√ëA
40952 - DROGUERIA PINEDA	CR.15 A # 11 - 02 (B. SAN AGUSTIN) - OCA√ëA
DROGUERIA SAN AGUSTIN	CL 11 # 16-12 OCA√ëA
40337 - DROGUERIA X SAN AGUSTIN	CL. 11 # 15 -10 (B. SAN AGUSTIN) - OCA√ëA
26367 - DROGUERIA LA DOCE	CL 12 # 6 - 119 - OCA√ëA
39778 - DROGUERIA CLAVIJO	CR 13 # 9 - 34 - OCA√ëA
DROGUERIA SANTA ANA	CR 13 # 10 - 71 OCA√ëA
DROGUERIA DROGAS SALUD	Calle 7 #29 143 OCA√ëA
25113 - DROGUERIA CENTRAL OCA√ëA	CR 12 # 9 - 60 - OCA√ëA
40159 - DROGUERIA LA X 5	 OCA√ëA/03(B.LAS LLAMADAS) /CL 7 # 26
37955 - DROGUERIA LUPITA	 OCA√ëA/07 SANTA CLARA /CR 49 N¬∞ 4`;

            const lines = rawData.split('\n');
            const parsed = [];

            lines.forEach(line => {
                if (!line.trim()) return;
                
                let parts = line.split('\t');
                
                // Si no hay tabs, intentamos separar por 2 o m√°s espacios
                if (parts.length < 2) {
                     parts = line.split(/\s{2,}/); 
                }

                if (parts.length >= 2) {
                    let nombre = parts[0].trim();
                    let direccion = parts[parts.length - 1].trim();
                    let cadena = 'General';

                    // L√≥gica para detectar cadena si existe una columna en medio
                    if (parts.length > 2) {
                        cadena = parts[1].trim(); 
                    } else {
                        // Inferencia basada en nombre
                        const upperName = nombre.toUpperCase();
                        if (upperName.includes("CRUZ VERDE")) cadena = "Cruz Verde";
                        else if (upperName.includes("ALEMANA")) cadena = "Alemana";
                        else if (upperName.includes("PAGUE MENOS")) cadena = "Pague Menos";
                        else if (upperName.includes("GRANADOS")) cadena = "Granados";
                    }

                    // IMPORTANTE: Ya no filtramos duplicados para asegurar que aparezcan las 329 farmacias.
                    parsed.push({
                        nombre,
                        cadena,
                        direccion,
                        visitado: 'Pendiente',
                        transferencia: 'Pendiente'
                    });
                }
            });

            return parsed;
        }

        // === UTILS ===
        function showToast(msg, type = 'info') {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.style.borderLeft = `4px solid var(--${type === 'success' ? 'success' : type === 'error' ? 'danger' : 'primary'}-500)`;
            toast.innerHTML = `<span>${type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : '‚ÑπÔ∏è'}</span> ${msg}`;
            document.getElementById('toast-container').appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // Event Listeners (Filtros)
        Object.values(elements.filters).forEach(f => f.addEventListener('change', applyFilters));
        elements.searchBox.addEventListener('input', (e) => {
            clearTimeout(window.searchTimeout);
            window.searchTimeout = setTimeout(applyFilters, 300);
        });
        document.getElementById('btn-reset-filters').addEventListener('click', () => {
            elements.searchBox.value = '';
            elements.filters.visitado.value = '';
            elements.filters.transferencia.value = '';
            elements.filters.cadena.value = '';
            applyFilters();
        });

        // Theme Toggle
        const themeToggle = document.getElementById('theme-toggle');
        themeToggle.addEventListener('click', () => {
            const html = document.documentElement;
            const current = html.getAttribute('data-theme');
            const next = current === 'dark' ? 'light' : 'dark';
            html.setAttribute('data-theme', next);
            themeToggle.querySelector('span').textContent = next === 'dark' ? '‚òÄÔ∏è' : 'üåô';
        });

        // Reinicio de Mes
        document.getElementById('reset-indicators-btn')?.addEventListener('click', () => document.getElementById('reset-modal').style.display = 'flex');
        document.getElementById('cancel-reset')?.addEventListener('click', () => document.getElementById('reset-modal').style.display = 'none');
        document.getElementById('confirm-reset')?.addEventListener('click', async () => {
            document.getElementById('reset-modal').style.display = 'none';
            showToast('Reiniciando indicadores...', 'info');
            const batch = writeBatch(db);
            allPharmacies.forEach(p => {
                batch.update(doc(db, 'pharmacies', p.id), { visitado: 'Pendiente', transferencia: 'Pendiente' });
            });
            await batch.commit();
            showToast('Indicadores reiniciados', 'success');
        });
    </script>
</body>
</html>
